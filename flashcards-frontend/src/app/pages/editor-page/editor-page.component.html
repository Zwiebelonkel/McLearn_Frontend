<app-loader *ngIf="loading()" />
<div *ngIf="!loading()" class="container">
  <a routerLink="/" class="back-link">← {{ 'back' | translate }}</a>
  <h2 class="page-title">{{ 'edit_cards' | translate }}</h2>

  <!-- Stack-Einstellungen -->
  <div *ngIf="canEdit" class="stack-meta">
    <label>
      {{ 'name' | translate }}:
      <input *ngIf="stack()" [(ngModel)]="stack()!.name" name="stackName" class="form-input" />
    </label>
    <label class="toggle-switch">
      <input type="checkbox" [(ngModel)]="isPublic" />
      <span class="slider"></span>
      <span class="toggle-label">{{ 'public' | translate }}</span>
    </label>

    <button (click)="saveStack()" class="btn btn-secondary">{{ 'save_meta' | translate }}</button>
    <button *ngIf="isOwner" (click)="openCollaboratorsModal()" class="btn btn-secondary">{{ 'collaborators' | translate }}</button>
  </div>

  <!-- Karten-Hinzufügen -->
  <form (submit)="add($event)" class="add-form">
    <input
      type="text"
      [(ngModel)]="front"
      name="front"
      placeholder="{{ 'question' | translate }}"
      required
      class="form-input"
    />
        <div class="image-upload-container">
      <button type="button" (click)="openImageUploader()" class="btn btn-secondary"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#fff"><path d="M480-480ZM200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h320v80H200v560h560v-280h80v280q0 33-23.5 56.5T760-120H200Zm40-160h480L570-480 450-320l-90-120-120 160Zm480-280v-167l-64 63-56-56 160-160 160 160-56 56-64-63v167h-80Z"/></svg></button>
      <div *ngIf="frontImage" class="image-preview-container">
        <img [src]="frontImage" class="image-preview" />
        <button type="button" (click)="removeImage()" class="btn btn-danger remove-image-btn"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#fff"><path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/></svg></button>
      </div>
    </div>
    <div class="divider"></div>

    <!-- Markdown Toolbar (nur für Rückseite) -->
    <div class="markdown-toolbar">
      <button type="button" (click)="insert('bold')"><b>B</b></button>
      <button type="button" (click)="insert('italic')"><i>I</i></button>
      <button type="button" (click)="insert('code')">Code</button>
      <button type="button" (click)="insert('ul')">List</button>
      <button type="button" (click)="insert('center')">Center</button>
    </div>

    <textarea
      #backArea
      [(ngModel)]="back"
      name="back"
      placeholder="{{ 'answer' | translate }}"
      required
      class="form-textarea"
      rows="4"
    ></textarea>
    <div class="divider"></div>

    <!-- Buttons nebeneinander -->
<div class="form-actions">
  <button type="submit" class="btn btn-primary">{{ 'add' | translate }}</button>

  <!-- CSV-Import -->
  <label class="btn btn-success csv-upload">
    Upload CSV <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M440-320v-326L336-542l-56-58 200-200 200 200-56 58-104-104v326h-80ZM240-160q-33 0-56.5-23.5T160-240v-120h80v120h480v-120h80v120q0 33-23.5 56.5T720-160H240Z"/></svg>
    <input type="file" (change)="importCSV($event)" hidden accept=".csv" />
  </label>

  <!-- CSV-Export -->
  <button type="button" (click)="exportCSV()" class="btn btn-success csv-export">
    Export CSV 
    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3">
      <path d="M480-320 280-520l56-58 104 104v-326h80v326l104-104 56 58-200 200ZM240-160q-33 0-56.5-23.5T160-240v-120h80v120h480v-120h80v120q0 33-23.5 56.5T720-160H240Z"/>
    </svg>
  </button>
</div>
  </form>

  <div class="search-wrapper">
    <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
      <circle cx="11" cy="11" r="7" />
      <line x1="21" y1="21" x2="16.65" y2="16.65" />
    </svg>
    <input
      type="text"
      [(ngModel)]="search"
      placeholder="Search cards..."
      class="form-input search-input"
    />
  </div>
  <div *ngIf="selectedCardIds.size > 0 && isOwner" class="panels">
    <button type="button" (click)="deleteSelected()" class="btn btn-fixed btn-danger" [disabled]="!hasSelection()">{{ 'delete_selected' | translate }}</button>
    <button type="button" (click)="saveSelected()" class="btn btn-fixed btn-secondary" [disabled]="!hasSelection()">{{ 'save_selected' | translate }}</button>
  </div>
  <!-- Karten-Liste -->
  <div class="card-list">
    <div *ngFor="let c of filteredCards" class="card" [class.selected]="isSelected(c) && isOwner" (click)="isOwner && toggleSelection(c)">
      <div class="card-header">
        <b>{{ c.front }}</b> — {{ c.back }} (Box {{ c.box }})
      </div>
      <div class="card-body">
        <label>{{ 'front' | translate }}:
          <input (click)="$event.stopPropagation()" [(ngModel)]="c.front" name="f{{c.id}}" class="form-input" [disabled]="!canEdit" />
        </label>
        <div class="image-upload-container">
          <button *ngIf="canEdit" type="button" (click)="openCardImageUploader(c); $event.stopPropagation()" class="btn btn-secondary"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#fff"><path d="M480-480ZM200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h320v80H200v560h560v-280h80v280q0 33-23.5 56.5T760-120H200Zm40-160h480L570-480 450-320l-90-120-120 160Zm480-280v-167l-64 63-56-56 160-160 160 160-56 56-64-63v167h-80Z"/></svg></button>
          <div *ngIf="c.front_image" class="image-preview-container">
              <img [src]="c.front_image" class="image-preview" />
              <button *ngIf="canEdit" type="button" (click)="removeCardImage(c)" class="btn btn-danger remove-image-btn"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#fff"><path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/></svg></button>
          </div>
      </div>
        <div class="divider"></div>
        <label>{{ 'back' | translate }}:
          <textarea (click)="$event.stopPropagation()" [(ngModel)]="c.back" name="b{{c.id}}" class="form-textarea" rows="3" [disabled]="!canEdit"></textarea>
        </label>
      </div>
      <div *ngIf="canEdit" class="card-footer">
        <!-- Checkbox links -->
      
        <!-- Buttons rechts 
        <div class="btn-group">
          <button (click)="save(c); $event.stopPropagation()" class="btn btn-secondary">{{ 'save' | translate }}</button>
          <button (click)="del(c); $event.stopPropagation()" class="btn btn-danger">{{ 'delete' | translate }}</button>
        </div>
        -->
      </div>
      
    </div>
  </div>
</div>

<!-- Collaborators Modal -->
<div class="modal" [class.is-open]="showCollaboratorsModal()">
  <div class="modal-content">
    <!-- Header -->
    <div class="modal-header">
      <h3 class="modal-title">{{ 'manage_collaborators' | translate }}</h3>
      <button class="modal-close" (click)="closeCollaboratorsModal()">×</button>
    </div>

    <!-- Body -->
    <div class="modal-body" *ngIf="stack()">
      
      <!-- Collaborators List -->
      <section class="collaborators-section">
        <h4>{{ 'current_collaborators' | translate }}</h4>
        <ul *ngIf="stack()?.collaborators?.length">
          <li *ngFor="let c of stack()?.collaborators">
            <div class="collaborator-info">
              {{ c.user_name }}
              <button (click)="removeCollaborator(c.id)" class="btn btn-danger btn-sm">
                {{ 'remove' | translate }}
              </button>
            </div>
          </li>
        </ul>
        <p *ngIf="!stack()?.collaborators?.length">No collaborators yet.</p>
      </section>

      <!-- Add Collaborator -->
      <section class="add-collaborator-section">
        <h4>{{ 'add_collaborator' | translate }}</h4>
        <input
        class="form-input"
          type="text"
          [(ngModel)]="inviteeSearch"
          (input)="searchUsers()"
          placeholder="{{ 'search_user' | translate }}"
        />
        <ul *ngIf="searchedUsers.length">
          <li *ngFor="let user of searchedUsers">
            <div class="collaborator-info">
              {{ user.name }}
              <button (click)="addCollaborator(user.id)" class="btn btn-primary btn-sm">
                {{ 'add' | translate }}
              </button>
            </div>
          </li>
        </ul>
      </section>

    </div>

    <!-- Footer -->
    <div class="modal-footer">
    </div>
  </div>
</div>