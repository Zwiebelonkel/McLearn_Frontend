<app-loader *ngIf="loading()" />
<div *ngIf="!loading()" class="container">
  <a routerLink="/" class="back-link">‚Üê {{ 'back' | translate }}</a>
  <h2 class="page-title">{{ 'edit_cards' | translate }}</h2>

  <!-- Stack-Einstellungen -->
  <div *ngIf="canEdit" class="stack-meta">
    <div class="stack-meta-header">
      <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor">
        <path d="M480-345 240-585l56-56 184 184 184-184 56 56-240 240Zm0 240L240-345l56-56 184 184 184-184 56 56-240 240Z"/>
      </svg>
      <h3>{{ 'stack_settings' | translate }}</h3>
    </div>
    
    <div class="stack-meta-body">
      <div class="form-group">
        <label class="form-label">
          <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px" fill="currentColor">
            <path d="M160-200v-80h80v-280q0-83 50-147.5T420-792v-28q0-25 17.5-42.5T480-880q25 0 42.5 17.5T540-820v28q80 20 130 84.5T720-560v280h80v80H160Zm320-300Zm0 420q-33 0-56.5-23.5T400-160h160q0 33-23.5 56.5T480-80ZM320-280h320v-280q0-66-47-113t-113-47q-66 0-113 47t-47 113v280Z"/>
          </svg>
          {{ 'name' | translate }}
        </label>
        <input 
          *ngIf="stack()" 
          [(ngModel)]="stack()!.name" 
          name="stackName" 
          class="form-input stack-name-input" 
          placeholder="Enter stack name..."
        />
      </div>

      <div class="form-group">
        <label class="form-label">
          <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px" fill="currentColor">
            <path d="M480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z"/>
          </svg>
          {{ 'visibility' | translate }}
        </label>
        <label class="toggle-switch modern">
          <input type="checkbox" [(ngModel)]="isPublic" />
          <span class="slider"></span>
          <span class="toggle-label">
            <span class="toggle-status">{{ isPublic ? ('public' | translate) : ('private' | translate) }}</span>
          </span>
        </label>
      </div>
    </div>

    <div class="stack-meta-actions">
      <button (click)="saveStack()" class="btn btn-primary btn-with-icon">
        <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor">
          <path d="M840-680v480q0 33-23.5 56.5T760-120H200q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h480l160 160Zm-80 34L646-760H200v560h560v-446ZM480-240q50 0 85-35t35-85q0-50-35-85t-85-35q-50 0-85 35t-35 85q0 50 35 85t85 35ZM240-560h360v-160H240v160Zm-40-86v446-560 114Z"/>
        </svg>
        {{ 'save' | translate }}
      </button>
      
      <button *ngIf="isOwner" (click)="openCollaboratorsModal()" class="btn btn-outline btn-with-icon">
        <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor">
          <path d="M40-160v-112q0-34 17.5-62.5T104-378q62-31 126-46.5T360-440q66 0 130 15.5T616-378q29 15 46.5 43.5T680-272v112H40Zm720 0v-120q0-44-24.5-84.5T666-434q51 6 96 20.5t84 35.5q36 20 55 44.5t19 53.5v120H760ZM360-480q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47Zm400-160q0 66-47 113t-113 47q-11 0-28-2.5t-28-5.5q27-32 41.5-71t14.5-81q0-42-14.5-81T544-792q14-5 28-6.5t28-1.5q66 0 113 47t47 113ZM120-240h480v-32q0-11-5.5-20T580-306q-54-27-109-40.5T360-360q-56 0-111 13.5T140-306q-9 5-14.5 14t-5.5 20v32Zm240-320q33 0 56.5-23.5T440-640q0-33-23.5-56.5T360-720q-33 0-56.5 23.5T280-640q0 33 23.5 56.5T360-560Zm0 320Zm0-400Z"/>
        </svg>
        {{ 'manage_collaborators' | translate }}
      </button>
    </div>
  </div>

  <!-- Karten-Hinzuf√ºgen -->
  <form (submit)="add($event)" class="add-form">
    <div class="input-row">
      <input
        type="text"
        [(ngModel)]="front"
        name="front"
        placeholder="{{ 'question' | translate }}"
        required
        class="form-input"
      />
      <button type="button" (click)="openImageUploader()" class="btn btn-secondary btn-icon-only">
        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#fff">
          <path d="M480-480ZM200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h320v80H200v560h560v-280h80v280q0 33-23.5 56.5T760-120H200Zm40-160h480L570-480 450-320l-90-120-120 160Zm480-280v-167l-64 63-56-56 160-160 160 160-56 56-64-63v167h-80Z"/>
        </svg>
      </button>
    </div>
    
    <div *ngIf="frontImage" class="image-preview-container">
      <img [src]="frontImage" class="image-preview" />
      <button type="button" (click)="removeImage()" class="btn btn-danger remove-image-btn">
        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#fff">
          <path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/>
        </svg>
      </button>
    </div>
    
    <div class="divider"></div>

<div class="markdown-toolbar">

  <!-- Text -->
  <button type="button" (click)="insert('bold')" title="Bold"><b>B</b></button>
  <button type="button" (click)="insert('italic')" title="Italic"><i>I</i></button>
  <button type="button" (click)="insert('underline')" title="Underline"><u>U</u></button>
  <button type="button" (click)="insert('strikethrough')" title="Strike"><s>S</s></button>
  <button type="button" (click)="insert('highlight')" title="Highlight">üñç</button>

  <span class="toolbar-divider"></span>

  <!-- Headings -->
  <button type="button" (click)="insert('h1')" title="H1">H1</button>
  <button type="button" (click)="insert('h2')" title="H2">H2</button>
  <button type="button" (click)="insert('h3')" title="H3">H3</button>

  <span class="toolbar-divider"></span>

  <!-- Code -->
<button type="button" (click)="insert('code')" title="Inline Code">
  &#123; &#125;
</button>
  <button type="button" (click)="insert('codeblock')" title="Code Block">```</button>

  <span class="toolbar-divider"></span>

  <!-- Lists -->
  <button type="button" (click)="insert('ul')" title="Bullet List">‚Ä¢ List</button>
  <button type="button" (click)="insert('ol')" title="Numbered List">1. List</button>

  <span class="toolbar-divider"></span>

  <!-- Quotes / Layout -->
  <button type="button" (click)="insert('blockquote')" title="Quote">‚ùù</button>
  <button type="button" (click)="insert('center')" title="Center">‚éØ‚éØ‚éØ</button>

  <span class="toolbar-divider"></span>

  <!-- Extras -->
  <button type="button" (click)="insert('link')" title="Link">üîó</button>
  <button type="button" (click)="insert('table')" title="Table">‚ñ¶</button>

</div>

    <textarea
      #backArea
      [(ngModel)]="back"
      name="back"
      placeholder="{{ 'answer' | translate }}"
      required
      class="form-textarea"
      rows="4"
    ></textarea>
    <div class="divider"></div>

    <!-- Buttons nebeneinander -->
    <div class="form-actions">
      <button type="submit" class="btn btn-primary">{{ 'add' | translate }}</button>

      <!-- CSV-Import -->
      <label class="btn btn-success csv-upload" [class.disabled]="isImporting()">
        Upload CSV <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M440-320v-326L336-542l-56-58 200-200 200 200-56 58-104-104v326h-80ZM240-160q-33 0-56.5-23.5T160-240v-120h80v120h480v-120h80v120q0 33-23.5 56.5T720-160H240Z"/></svg>
        <input type="file" (change)="importCSV($event)" [disabled]="isImporting()" hidden accept=".csv" />
      </label>

      <!-- CSV-Export -->
      <button type="button" (click)="exportCSV()" class="btn btn-success csv-export">
        Export CSV 
        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3">
          <path d="M480-320 280-520l56-58 104 104v-326h80v326l104-104 56 58-200 200ZM240-160q-33 0-56.5-23.5T160-240v-120h80v120h480v-120h80v120q0 33-23.5 56.5T720-160H240Z"/>
        </svg>
      </button>
    </div>
  </form>

  <div class="search-wrapper">
    <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
      <circle cx="11" cy="11" r="7" />
      <line x1="21" y1="21" x2="16.65" y2="16.65" />
    </svg>
    <input
      type="text"
      [(ngModel)]="search"
      placeholder="Search cards..."
      class="form-input search-input"
    />
  </div>
  <div *ngIf="selectedCardIds.size > 0 && isOwner" class="panels">
    <button type="button" (click)="deleteSelected()" class="btn btn-fixed btn-danger" [disabled]="!hasSelection()">{{ 'delete_selected' | translate }}</button>
  </div>
  <!-- Karten-Liste -->
  <div class="card-list">
    <div *ngFor="let c of filteredCards" class="card" [class.selected]="isSelected(c) && isOwner" (click)="isOwner && toggleSelection(c)">
      <div class="card-header">
        <span class="save-indicator">

          <!-- Saving -->
          <span *ngIf="savingCards.has(c.id)" class="saving">
            <svg 
            class="spinner status-icon" 
            xmlns="http://www.w3.org/2000/svg" 
            height="16px" 
            viewBox="0 -960 960 960" 
            width="16px" 
            fill="currentColor">
            <path d="M480-80q-82 0-155-31.5t-127.5-86Q143-252 111.5-325T80-480q0-83 31.5-155.5t86-127Q252-817 325-848.5T480-880q17 0 28.5 11.5T520-840q0 17-11.5 28.5T480-800q-133 0-226.5 93.5T160-480q0 133 93.5 226.5T480-160q133 0 226.5-93.5T800-480q0-17 11.5-28.5T840-520q17 0 28.5 11.5T880-480q0 82-31.5 155t-86 127.5q-54.5 54.5-127 86T480-80Z"/>
          </svg>
          </span>
      
          <!-- Error -->
          <span *ngIf="saveErrorCards.has(c.id)" class="error">
            ‚ö†
          </span>
      
          <!-- Saved -->
          <span
            *ngIf="
              !savingCards.has(c.id) &&
              !saveErrorCards.has(c.id) &&
              lastSavedBack.get(c.id) === c.back &&
              lastSavedFront.get(c.id) === c.front
            "
            class="saved">
            <svg 
            xmlns="http://www.w3.org/2000/svg" 
            height="16px" 
            viewBox="0 -960 960 960" 
            width="16px" 
            fill="currentColor"
            class="status-icon">
            <path d="M382-240 154-468l57-57 171 171 367-367 57 57-424 424Z"/>
          </svg>
          </span>
      
        </span>
        <b>{{ c.front }}</b> ‚Äî {{ c.back }} (Box {{ c.box }})
      </div>
      <div class="card-body">
        <label>{{ 'front' | translate }}:</label>
        <div class="input-row">
          <input
  (click)="$event.stopPropagation()"
  [(ngModel)]="c.front"
  (ngModelChange)="onCardChange(c, 'front')"
  name="f{{c.id}}"
  class="form-input"
  [disabled]="!canEdit"
/>
          <button *ngIf="canEdit" type="button" (click)="openCardImageUploader(c); $event.stopPropagation()" class="btn btn-secondary btn-icon-only">
            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#fff">
              <path d="M480-480ZM200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h320v80H200v560h560v-280h80v280q0 33-23.5 56.5T760-120H200Zm40-160h480L570-480 450-320l-90-120-120 160Zm480-280v-167l-64 63-56-56 160-160 160 160-56 56-64-63v167h-80Z"/>
            </svg>
          </button>
        </div>
        
        <div *ngIf="c.front_image" class="image-preview-container">
          <img [src]="c.front_image" class="image-preview" />
          <button *ngIf="canEdit" type="button" (click)="removeCardImage(c); $event.stopPropagation()" class="btn btn-danger remove-image-btn">
            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#fff">
              <path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/>
            </svg>
          </button>
        </div>
        
        <div class="divider"></div>
        <label>{{ 'back' | translate }}:
          <textarea
  (click)="$event.stopPropagation()"
  [(ngModel)]="c.back"
  (ngModelChange)="onCardChange(c, 'back')"
  name="b{{c.id}}"
  class="form-textarea"
  rows="3"
  [disabled]="!canEdit">
</textarea>
        </label>
      </div>
    </div>
  </div>
</div>

<!-- Import Progress Modal -->
<div *ngIf="isImporting()" class="import-progress-overlay">
  <div class="import-progress-modal">
    <h3>
      <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor">
        <path d="M480-80q-82 0-155-31.5t-127.5-86Q143-252 111.5-325T80-480q0-83 31.5-155.5t86-127Q252-817 325-848.5T480-880q17 0 28.5 11.5T520-840q0 17-11.5 28.5T480-800q-133 0-226.5 93.5T160-480q0 133 93.5 226.5T480-160q133 0 226.5-93.5T800-480q0-17 11.5-28.5T840-520q17 0 28.5 11.5T880-480q0 82-31.5 155t-86 127.5q-54.5 54.5-127 86T480-80Z"/>
      </svg>
      Importing Cards...
    </h3>
    
    <div class="progress-bar-container">
      <div class="progress-bar" [style.width.%]="importProgressPercent">
        {{ importProgressPercent }}%
      </div>
    </div>
    
    <p class="progress-text">
      <strong>{{ importProgress() }}</strong> of <strong>{{ importTotal() }}</strong> cards imported
    </p>
  </div>
</div>

<!-- Collaborators Modal -->
<div class="modal" [class.is-open]="showCollaboratorsModal()">
  <div class="modal-content">
    <!-- Header -->
    <div class="modal-header">
      <h3 class="modal-title">{{ 'manage_collaborators' | translate }}</h3>
      <button class="modal-close" (click)="closeCollaboratorsModal()">√ó</button>
    </div>

    <!-- Body -->
    <div class="modal-body" *ngIf="stack()">
      
      <!-- Collaborators List -->
      <section class="collaborators-section">
        <h4>{{ 'current_collaborators' | translate }}</h4>
        <ul *ngIf="stack()?.collaborators?.length">
          <li *ngFor="let c of stack()?.collaborators">
            <div class="collaborator-info">
              {{ c.user_name }}
              <button (click)="removeCollaborator(c.id)" class="btn btn-danger btn-sm">
                {{ 'remove' | translate }}
              </button>
            </div>
          </li>
        </ul>
        <p *ngIf="!stack()?.collaborators?.length">No collaborators yet.</p>
      </section>

      <!-- Add Collaborator -->
      <section class="add-collaborator-section">
        <h4>{{ 'add_collaborator' | translate }}</h4>
        <input
        class="form-input"
          type="text"
          [(ngModel)]="inviteeSearch"
          (input)="searchUsers()"
          placeholder="{{ 'search_user' | translate }}"
        />
        <ul *ngIf="searchedUsers.length">
          <li *ngFor="let user of searchedUsers">
            <div class="collaborator-info">
              {{ user.name }}
              <button (click)="addCollaborator(user.id)" class="btn btn-primary btn-sm">
                {{ 'add' | translate }}
              </button>
            </div>
          </li>
        </ul>
      </section>

    </div>

    <!-- Footer -->
    <div class="modal-footer">
    </div>
  </div>
</div>