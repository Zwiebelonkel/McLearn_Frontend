<a routerLink="/stacks" class="back-link">â† {{ 'back' | translate }}</a>

<div class="container" (touchstart)="handleTouchStart($event)" (touchend)="handleTouchEnd($event)">

  <!-- Progress Bar -->
  <div class="progress-container">
    <div class="progress-info">
      <span class="progress-text">{{ getProgressText() }}</span>
      <span class="progress-percent">{{ getProgressPercent() }}%</span>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" [style.width.%]="getProgressPercent()"></div>
    </div>
  </div>

  <!-- Quiz Completed Screen -->
  <ng-container *ngIf="quizCompleted(); else quizActive">
    <div class="completion-screen">
      <div class="completion-icon">ğŸ‰</div>
      <h2>{{ 'quiz_completed' | translate }}</h2>
      <p>{{ 'quiz_completed_message' | translate: {total: cards().length} }}</p>
      
      <div class="completion-actions">
        <button (click)="restartQuiz()" class="btn btn-primary">
          <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor">
            <path d="M440-122q-121-15-200.5-105.5T160-440q0-66 26-126.5T260-672l57 57q-38 34-57.5 79T240-440q0 88 56 155.5T440-202v80Zm80 0v-80q87-16 143.5-83T720-440q0-100-70-170t-170-70h-3l44 44-56 56-140-140 140-140 56 56-44 44h3q134 0 227 93t93 227q0 121-79.5 211.5T520-122Z"/>
          </svg>
          {{ 'restart_quiz' | translate }}
        </button>
        <button (click)="exitQuiz()" class="btn btn-secondary">
          <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor">
            <path d="m313-440 224 224-57 56-320-320 320-320 57 56-224 224h487v80H313Z"/>
          </svg>
          {{ 'back_to_study' | translate }}
        </button>
      </div>
    </div>
  </ng-container>

  <!-- Active Quiz -->
  <ng-template #quizActive>
    <ng-container *ngIf="currentCard; else noCards">
      <div class="card-wrapper">
        <div
          class="card"
          [class.flipped]="showBack()"
          (click)="flip()"
        >
          <div class="card-inner">
            <!-- Front Side -->
            <div class="card-front">
              <img 
                *ngIf="currentCard.front_image" 
                [src]="currentCard.front_image" 
                alt="Card image" 
                class="card-image">
              <p>{{ currentCard.front }}</p>
            </div>

            <!-- Back Side -->
            <div class="card-back">
              <div [innerHTML]="renderMarkdown(currentCard.back || '')"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Navigation Controls -->
      <div class="controls">
        <button 
          (click)="previousCard()" 
          class="btn btn-secondary btn-nav"
          [disabled]="currentIndex() === 0 || showBack()"
          [class.disabled]="currentIndex() === 0 || showBack()">
          <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor">
            <path d="M400-80 0-480l400-400 71 71-329 329 329 329-71 71Z"/>
          </svg>
          <span class="btn-text">{{ 'previous' | translate }}</span>
        </button>

        <button 
          *ngIf="!showBack()"
          (click)="flip()" 
          class="btn btn-primary btn-flip"
          [disabled]="isTransitioning()">
          <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor">
            <path d="M280-120q-33 0-56.5-23.5T200-200v-560q0-33 23.5-56.5T280-840h400q33 0 56.5 23.5T760-760v560q0 33-23.5 56.5T680-120H280Zm0-560v480-480Zm0 560h400v-480H280v480Zm80-280h240v-80H360v80Zm0 120h240v-80H360v80Z"/>
          </svg>
          {{ 'show_answer' | translate }}
        </button>

        <button 
          *ngIf="showBack()"
          (click)="nextCard()" 
          class="btn btn-success btn-next"
          [disabled]="isTransitioning()">
          <span class="btn-text">{{ 'next' | translate }}</span>
          <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor">
            <path d="m321-80-71-71 329-329-329-329 71-71 400 400L321-80Z"/>
          </svg>
        </button>

        <button 
          (click)="nextCard()" 
          class="btn btn-info btn-nav"
          [disabled]="!showBack() || isTransitioning()"
          [class.disabled]="!showBack() || isTransitioning()">
          <span class="btn-text">{{ 'next' | translate }}</span>
          <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor">
            <path d="m321-80-71-71 329-329-329-329 71-71 400 400L321-80Z"/>
          </svg>
        </button>
      </div>
    </ng-container>

    <ng-template #noCards>
      <div class="empty-state">
        <svg xmlns="http://www.w3.org/2000/svg" height="64px" viewBox="0 -960 960 960" width="64px" fill="currentColor">
          <path d="M240-400v80h-80q-33 0-56.5-23.5T80-400v-400q0-33 23.5-56.5T160-880h400q33 0 56.5 23.5T640-800v80h-80v-80H160v400h80ZM400-80q-33 0-56.5-23.5T320-160v-400q0-33 23.5-56.5T400-640h400q33 0 56.5 23.5T880-560v400q0 33-23.5 56.5T800-80H400Zm0-80h400v-400H400v400Zm200-200Z"/>
        </svg>
        <p>{{ 'no_cards_in_stack' | translate }}</p>
        <button (click)="exitQuiz()" class="btn btn-primary">
          {{ 'back_to_stacks' | translate }}
        </button>
      </div>
    </ng-template>
  </ng-template>
</div>