<app-loader *ngIf="loading()" />
<div *ngIf="!loading()">
  <div class="container">
    <h2 *ngIf="isLoggedIn()" class="page-title">{{ 'new' | translate }}</h2>

    <form *ngIf="isLoggedIn()" (submit)="create($event)" class="add-form">
      <input [(ngModel)]="name" name="name" placeholder="{{ 'new_stack' | translate }}" required class="form-input" />
      <button type="submit" class="btn btn-primary" [disabled]="!name || name.trim() === ''">
        {{ 'create' | translate }}
      </button>
    </form>

    <h2 class="page-title">{{ 'stacks' | translate }}</h2>

    <div class="filter-controls">
      <div class="search-wrapper">
        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
          <circle cx="11" cy="11" r="7" />
          <line x1="21" y1="21" x2="16.65" y2="16.65" />
        </svg>
        <input type="text" [(ngModel)]="search" placeholder="{{ 'search_stacks' | translate }}..."
          class="form-input search-input" />
      </div>

      <select *ngIf="isLoggedIn()" [(ngModel)]="filter" class="form-input select-input">
        <option value="all">{{ 'all' | translate }}</option>
        <option value="public">🌍 {{ 'public_only' | translate }}</option>
        <option value="own">🔒 {{ 'my_stacks' | translate }}</option>
      </select>
    </div>


    <ul class="stack-list">
      <li *ngFor="let s of filteredStacks" class="stack-item">
        <span class="stack-name">
          {{ s.name }}
          <span *ngIf="s.is_public && !isOwner(s) && s.owner_name">🌍 {{ 'by' | translate }} {{ s.owner_name }}</span>
          <span *ngIf="s.is_public && isOwner(s)">🌍</span>
          <span *ngIf="!s.is_public && isLoggedIn()">🔒</span>
        </span>
        <div class="stack-actions">
          <span class="card-amount">{{ s.card_amount }}</span>
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#d5d5d5">
            <path
              d="M240-400v80h-80q-33 0-56.5-23.5T80-400v-400q0-33 23.5-56.5T160-880h400q33 0 56.5 23.5T640-800v80h-80v-80H160v400h80ZM400-80q-33 0-56.5-23.5T320-160v-400q0-33 23.5-56.5T400-640h400q33 0 56.5 23.5T880-560v400q0 33-23.5 56.5T800-80H400Zm0-80h400v-400H400v400Zm200-200Z" />
          </svg>
          <a *ngIf="isOwner(s)" [routerLink]="['/stack', s.id, 'edit']" class="btn btn-secondary">{{ 'edit' |
            translate }}</a>
          <a [routerLink]="['/stack', s.id, 'study']" class="btn btn-success">{{ 'study' | translate }}</a>
          <button *ngIf="isOwner(s)" (click)="openCollaboratorsModal(s)" class="btn btn-info">{{ 'collaborators' | translate
            }}</button>
          <button *ngIf="isOwner(s)" (click)="remove(s)" class="btn btn-danger">{{ 'delete' | translate }}</button>
        </div>
      </li>
    </ul>
  </div>
</div>

<div class="modal" [class.is-open]="showCollaboratorsModal()">
  <div class="modal-content">
    <h3 class="modal-title">{{ 'manage_collaborators' | translate }}</h3>
    <div *ngIf="selectedStack">
      <div class="collaborators-list">
        <h4>{{ 'current_collaborators' | translate }}</h4>
        <ul>
          <li *ngFor="let c of selectedStack.collaborators">
            {{ c.user_name }}
            <button (click)="removeCollaborator(c.id)" class="btn btn-danger btn-sm">{{ 'remove' | translate }}</button>
          </li>
        </ul>
      </div>

      <div class="add-collaborator-form">
        <h4>{{ 'add_collaborator' | translate }}</h4>
        <input type="text" [(ngModel)]="inviteeSearch" (input)="searchUsers()" placeholder="{{ 'search_user' | translate }}" />
        <ul *ngIf="searchedUsers.length">
          <li *ngFor="let user of searchedUsers">
            {{ user.name }} ({{ user.email }})
            <button (click)="addCollaborator(user.id)" class="btn btn-primary btn-sm">{{ 'add' | translate }}</button>
          </li>
        </ul>
      </div>
    </div>
    <button (click)="closeCollaboratorsModal()" class="btn btn-secondary">{{ 'close' | translate }}</button>
  </div>
</div>